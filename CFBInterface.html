<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFB All Quarters Predictor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #000000;
            color: #ffffff;
            line-height: 1.6;
            font-size: 14px;
        }
        
        /* Header */
        .header { 
            background: #000000;
            border-bottom: 1px solid #1f1f1f;
            padding: 1rem 0;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo h1 { 
            color: #22c55e;
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }
        .status { font-size: 0.8125rem; color: #6b7280; }
        
        /* Main Layout */
        .main { padding: 1.5rem 0; }
        .layout { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
        
        /* Games Section */
        .section { 
            background: #000000;
            border-radius: 4px;
            border: 1px solid #262626;
        }
        .section-header { 
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid #262626;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-title { 
            font-size: 0.9375rem;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.0125em;
        }
        
        /* Game Cards - oddsview style */
        .game-card { 
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
            transition: background 0.15s ease;
            background: #000000;
        }
        .game-card:hover { 
            background: #0a0a0a;
        }
        .game-card.selected { 
            background: #15803d;
            border-left: 3px solid #22c55e;
        }
        .game-header { display: flex; justify-content: space-between; margin-bottom: 0.75rem; }
        .game-time { 
            font-size: 0.8125rem;
            color: #9ca3af;
            font-weight: 500;
        }
        .teams { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 0.75rem; }
        .team-name { 
            font-size: 0.9375rem;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.0125em;
        }
        .bet-chip { 
            background: #1a1a1a;
            padding: 0.1875rem 0.5rem;
            border-radius: 3px;
            color: #9ca3af;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #262626;
        }
        
        /* Period Selector */
        .period-selector {
            display: flex;
            gap: 0.5rem;
            padding: 0.875rem 1.25rem;
            background: #000000;
            border-bottom: 1px solid #262626;
            overflow-x: auto;
        }
        .period-tab {
            padding: 0.4375rem 0.875rem;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 4px;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s;
            letter-spacing: 0.0125em;
        }
        .period-tab:hover {
            background: #1a1a1a;
            color: #e5e7eb;
            border-color: #374151;
        }
        .period-tab.active {
            background: #22c55e;
            color: #000000;
            border-color: #22c55e;
        }
        
        /* Markets Display - oddsview style */
        .markets-content {
            padding: 1.25rem;
        }
        .market-section {
            margin-bottom: 1.75rem;
        }
        .market-section:last-child {
            margin-bottom: 0;
        }
        .market-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.0125em;
        }
        .market-subtitle {
            font-size: 0.6875rem;
            color: #6b7280;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        /* Market Lines - oddsview table style */
        .market-line {
            display: grid;
            grid-template-columns: 60px 1fr 1fr;
            gap: 0.625rem;
            align-items: stretch;
            margin-bottom: 0.5rem;
        }
        .line-label {
            font-size: 0.875rem;
            color: #ffffff;
            font-weight: 600;
            display: flex;
            align-items: center;
            padding-left: 0.25rem;
        }
        .market-option {
            padding: 0.625rem 0.75rem;
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .market-option:hover {
            background: #141414;
            border-color: #262626;
        }
        .market-option.selected {
            background: #15803d;
            border-color: #22c55e;
        }
        .market-option .team {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
            letter-spacing: -0.0125em;
        }
        .market-option .prob {
            font-size: 0.875rem;
            color: #22c55e;
            font-weight: 600;
        }
        .market-option .odds {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.125rem;
        }
        
        /* Moneyline Grid */
        .moneyline-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.625rem;
        }
        .moneyline-3way {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.625rem;
        }
        
        /* SGP Builder */
        .sgp-builder {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            padding: 1.25rem;
            margin-bottom: 1.75rem;
        }
        .sgp-title {
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.875rem;
            letter-spacing: -0.0125em;
        }
        .sgp-selections {
            margin-bottom: 0.875rem;
        }
        .sgp-selection {
            background: #141414;
            padding: 0.625rem 0.75rem;
            border-radius: 3px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #1a1a1a;
        }
        .sgp-selection-text {
            font-size: 0.8125rem;
            color: #e5e7eb;
            font-weight: 500;
        }
        .sgp-period-badge {
            background: #1a1a1a;
            padding: 0.125rem 0.4375rem;
            border-radius: 3px;
            font-size: 0.6875rem;
            color: #9ca3af;
            margin-right: 0.5rem;
            font-weight: 600;
            border: 1px solid #262626;
        }
        .remove-btn {
            background: #7f1d1d;
            color: white;
            border: none;
            padding: 0.25rem 0.625rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.6875rem;
            font-weight: 600;
            transition: background 0.15s;
        }
        .remove-btn:hover {
            background: #991b1b;
        }
        .sgp-result {
            background: #141414;
            border-radius: 4px;
            padding: 0.875rem;
            border: 1px solid #1a1a1a;
        }
        .sgp-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.875rem;
            text-align: center;
        }
        .sgp-stat-label {
            font-size: 0.6875rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .sgp-stat-value {
            font-size: 1.375rem;
            font-weight: 700;
            color: #22c55e;
        }
        
        /* Manual Input */
        .manual-input {
            background: #000000;
            border: 1px solid #262626;
            border-radius: 4px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.875rem;
            margin-bottom: 0.875rem;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .input-label {
            font-size: 0.8125rem;
            color: #9ca3af;
            margin-bottom: 0.375rem;
            font-weight: 500;
        }
        input {
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 4px;
            padding: 0.625rem 0.75rem;
            color: #ffffff;
            font-size: 0.875rem;
        }
        input:focus {
            outline: none;
            border-color: #22c55e;
        }
        button {
            background: #22c55e;
            color: #000000;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        button:hover {
            background: #16a34a;
        }
        
        /* Loading & Error States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }
        .spinner {
            border: 3px solid #1a1a1a;
            border-top: 3px solid #22c55e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #7f1d1d;
            color: #fecaca;
            padding: 0.875rem;
            border-radius: 4px;
            margin: 1rem;
            border: 1px solid #991b1b;
        }
        .no-selection {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        /* Top Scores */
        .top-scores {
            background: #0a0a0a;
            border-radius: 4px;
            padding: 0.875rem;
            margin-bottom: 1.25rem;
            border: 1px solid #1a1a1a;
        }
        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4375rem 0;
            border-bottom: 1px solid #1a1a1a;
        }
        .score-item:last-child {
            border-bottom: none;
        }
        .score-label {
            font-size: 0.875rem;
            color: #e5e7eb;
            font-weight: 500;
        }
        .score-prob {
            font-size: 0.875rem;
            font-weight: 600;
            color: #22c55e;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>CFB All Quarters</h1>
                </div>
                <div class="status" id="status">Loading...</div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="container">
            <div class="layout">
                <!-- Games List -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title" id="games-title">Upcoming Games</span>
                        <button onclick="loadGames()" style="padding: 0.5rem 1rem; font-size: 0.75rem;">Refresh</button>
                    </div>
                    <div id="games-list" class="loading">
                        <div class="spinner"></div>
                        <p>Loading games...</p>
                    </div>
                </div>

                <!-- Markets Display -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">Markets & Predictions</span>
                    </div>
                    
                    <!-- SGP Builder -->
                    <div id="sgp-section" style="display: none; padding: 1.5rem;">
                        <div class="sgp-builder">
                            <div class="sgp-title">SGP Builder</div>
                            <div id="sgp-selections" class="sgp-selections">
                                <div style="color: #6b7280; text-align: center;">Select markets below to build parlay</div>
                            </div>
                            <div id="sgp-result" style="display: none;">
                                <div class="sgp-result">
                                    <div class="sgp-stats">
                                        <div>
                                            <div class="sgp-stat-label">Probability</div>
                                            <div class="sgp-stat-value" id="sgp-prob">0%</div>
                                        </div>
                                        <div>
                                            <div class="sgp-stat-label">Fair Odds</div>
                                            <div class="sgp-stat-value" id="sgp-odds">+0</div>
                                        </div>
                                        <div>
                                            <div class="sgp-stat-label">Decimal</div>
                                            <div class="sgp-stat-value" id="sgp-decimal">0.00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Period Selector -->
                    <div id="period-selector" style="display: none;" class="period-selector">
                        <div class="period-tab active" onclick="switchPeriod('q1')">Q1</div>
                        <div class="period-tab" onclick="switchPeriod('q2')">Q2</div>
                        <div class="period-tab" onclick="switchPeriod('q3')">Q3</div>
                        <div class="period-tab" onclick="switchPeriod('q4')">Q4</div>
                        <div class="period-tab" onclick="switchPeriod('h1')">1st Half</div>
                        <div class="period-tab" onclick="switchPeriod('h2')">2nd Half</div>
                        <div class="period-tab" onclick="switchPeriod('full')">Full Game</div>
                    </div>
                    
                    <!-- Markets Content -->
                    <div id="markets-content" class="no-selection">
                        <p>Select a game to view markets</p>
                    </div>
                </div>
            </div>

            <!-- Manual Input -->
            <div class="manual-input">
                <h3 style="margin-bottom: 1rem; color: #f9fafb;">Manual Prediction</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label class="input-label">Home Team</label>
                        <input type="text" id="homeTeam" placeholder="Georgia">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Away Team</label>
                        <input type="text" id="awayTeam" placeholder="Alabama">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Spread (negative = home favored)</label>
                        <input type="number" id="spread" step="0.5" placeholder="-3.5">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Total</label>
                        <input type="number" id="total" step="0.5" placeholder="58.5">
                    </div>
                </div>
                <button onclick="generateManualPrediction()" style="width: 100%;">Generate Predictions</button>
            </div>
        </div>
    </div>

    <script>
        let currentGames = [];
        let selectedGame = null;
        let currentData = null;
        let currentPeriod = 'q1';
        let parlaySelections = [];

        function getCurrentSeason() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const month = today.getMonth();
            return month >= 7 ? currentYear : currentYear - 1;
        }

        function getUpcomingGamesDateRange() {
            const today = new Date();
            const startDate = new Date(today);
            const endDate = new Date(today);
            const daysUntilSunday = (7 - today.getDay()) % 7 || 7;
            endDate.setDate(today.getDate() + daysUntilSunday);
            endDate.setHours(23, 59, 59, 999);
            return { startDate: startDate.toISOString(), endDate: endDate.toISOString() };
        }

        function updateStatus() {
            const season = getCurrentSeason();
            document.getElementById('status').textContent = `All Quarters Predictions - ${season} Season`;
        }

        async function loadGames() {
            const gamesList = document.getElementById('games-list');
            gamesList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading games...</p></div>';
            
            try {
                const season = getCurrentSeason();
                const { startDate, endDate } = getUpcomingGamesDateRange();
                
                const gamesResponse = await fetch(`/api/cfbd/games?year=${season}&seasonType=regular`);
                if (!gamesResponse.ok) throw new Error(`Games API error: ${gamesResponse.status}`);
                const allGamesData = await gamesResponse.json();
                
                const gamesData = allGamesData.filter(game => {
                    const gameDate = new Date(game.startDate);
                    return gameDate >= new Date(startDate) && gameDate <= new Date(endDate);
                });
                
                const linesResponse = await fetch(`/api/cfbd/lines?year=${season}&seasonType=regular`);
                let linesData = linesResponse.ok ? await linesResponse.json() : [];
                
                const processedGames = gamesData
                    .filter(game => game.homeClassification === 'fbs' || game.awayClassification === 'fbs')
                    .map(game => {
                        const gameLinesArray = linesData.filter(line => line.id === game.id);
                        let medianSpread = null, medianTotal = null;
                        
                        for (const lineGroup of gameLinesArray) {
                            if (lineGroup.lines && lineGroup.lines.length > 0) {
                                const spreads = [], totals = [];
                                for (const line of lineGroup.lines) {
                                    if (line.spread !== null) spreads.push(line.spread);
                                    if (line.overUnder !== null) totals.push(line.overUnder);
                                }
                                if (spreads.length > 0) {
                                    spreads.sort((a, b) => a - b);
                                    medianSpread = spreads[Math.floor(spreads.length / 2)];
                                }
                                if (totals.length > 0) {
                                    totals.sort((a, b) => a - b);
                                    medianTotal = totals[Math.floor(totals.length / 2)];
                                }
                                break;
                            }
                        }
                        return { ...game, spread: medianSpread, total: medianTotal };
                    })
                    .filter(game => game.spread !== null && game.total !== null)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                currentGames = processedGames;
                displayGames(processedGames);
            } catch (error) {
                gamesList.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displayGames(games) {
            const gamesList = document.getElementById('games-list');
            if (games.length === 0) {
                gamesList.innerHTML = '<div class="no-selection"><p>No games with betting lines found</p></div>';
                return;
            }
            
            gamesList.innerHTML = games.map((game, index) => `
                <div class="game-card" onclick="selectGame(${index})">
                    <div class="game-header">
                        <div class="game-time">${formatGameTime(game.startDate)}</div>
                    </div>
                    <div class="teams">
                        <div>
                            <div class="team-name">${game.awayTeam}</div>
                            <span class="bet-chip">Away</span>
                        </div>
                        <div>
                            <div class="team-name">${game.homeTeam}</div>
                            <span class="bet-chip">Home</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <span class="bet-chip">Spread: ${game.spread}</span>
                        <span class="bet-chip">Total: ${game.total}</span>
                    </div>
                </div>
            `).join('');
        }

        function formatGameTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ' ' +
                   date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        async function selectGame(index) {
            selectedGame = currentGames[index];
            document.querySelectorAll('.game-card').forEach((card, i) => 
                card.classList.toggle('selected', i === index)
            );
            
            await generatePredictions(
                selectedGame.spread,
                selectedGame.total,
                selectedGame.homeTeam,
                selectedGame.awayTeam
            );
        }

        async function generateManualPrediction() {
            const homeTeam = document.getElementById('homeTeam').value;
            const awayTeam = document.getElementById('awayTeam').value;
            const spread = parseFloat(document.getElementById('spread').value);
            const total = parseFloat(document.getElementById('total').value);
            
            if (!homeTeam || !awayTeam || isNaN(spread) || isNaN(total)) {
                alert('Please fill in all fields');
                return;
            }
            
            await generatePredictions(spread, total, homeTeam, awayTeam);
        }

        async function generatePredictions(spread, total, homeTeam, awayTeam) {
            const marketsContent = document.getElementById('markets-content');
            marketsContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating...</p></div>';
            
            document.getElementById('period-selector').style.display = 'none';
            document.getElementById('sgp-section').style.display = 'none';
            
            try {
                const response = await fetch('/api/predict-all-quarters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ spread, total, homeTeam, awayTeam })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentData = data;
                    currentPeriod = 'q1';
                    parlaySelections = [];
                    
                    document.getElementById('period-selector').style.display = 'flex';
                    document.getElementById('sgp-section').style.display = 'block';
                    
                    displayMarketsForPeriod(currentPeriod);
                } else {
                    throw new Error(`API error: ${response.status}`);
                }
            } catch (error) {
                marketsContent.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function switchPeriod(period) {
            currentPeriod = period;
            
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayMarketsForPeriod(period);
        }

        function displayMarketsForPeriod(period) {
            if (!currentData) return;
            
            console.log('=== DISPLAY MARKETS DEBUG ===');
            console.log('Period:', period);
            console.log('Current data structure:', currentData);
            console.log('Markets available:', Object.keys(currentData.markets || {}));
            
            const markets = currentData.markets[period];
            const predictions = currentData.predictions[period];
            const gameInfo = currentData.game_info;
            
            if (!markets) {
                console.error('No markets found for period:', period);
                document.getElementById('markets-content').innerHTML = 
                    `<div class="error">No markets available for ${period}</div>`;
                return;
            }
            
            console.log('Markets for period:', markets);
            console.log('Spread markets:', Object.keys(markets.spread || {}));
            console.log('Total markets:', Object.keys(markets.total || {}));
            
            const periodNames = {
                'q1': '1st Quarter',
                'q2': '2nd Quarter',
                'q3': '3rd Quarter',
                'q4': '4th Quarter',
                'h1': '1st Half',
                'h2': '2nd Half',
                'full': 'Full Game'
            };
            
            let html = '<div class="markets-content">';
            
            // Top Scores
            if (predictions && predictions.length > 0) {
                html += `
                    <div class="market-section">
                        <div class="market-title">Top Score Predictions</div>
                        <div class="top-scores">
                            ${predictions.slice(0, 5).map(pred => `
                                <div class="score-item">
                                    <span class="score-label">${pred.score}</span>
                                    <span class="score-prob">${(pred.probability * 100).toFixed(1)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // 2-Way Moneyline
            if (markets.moneyline_2way) {
                html += `
                    <div class="market-section">
                        <div class="market-title">2-Way Moneyline</div>
                        <div class="moneyline-grid">
                            <div class="market-option" onclick="selectMarket('moneyline', 'home', 0, '${gameInfo.home_team} ML', '${period}')">
                                <div class="team">${gameInfo.home_team}</div>
                                <div class="prob">${(markets.moneyline_2way.home * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.moneyline_2way.home_odds >= 0 ? '+' : ''}${markets.moneyline_2way.home_odds}</div>
                            </div>
                            <div class="market-option" onclick="selectMarket('moneyline', 'away', 0, '${gameInfo.away_team} ML', '${period}')">
                                <div class="team">${gameInfo.away_team}</div>
                                <div class="prob">${(markets.moneyline_2way.away * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.moneyline_2way.away_odds >= 0 ? '+' : ''}${markets.moneyline_2way.away_odds}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 3-Way Moneyline
            if (markets.moneyline_3way) {
                html += `
                    <div class="market-section">
                        <div class="market-title">3-Way Moneyline</div>
                        <div class="moneyline-3way">
                            <div class="market-option" onclick="selectMarket('moneyline_3way', 'home', 0, '${gameInfo.home_team} (3-way)', '${period}')">
                                <div class="team">${gameInfo.home_team}</div>
                                <div class="prob">${(markets.moneyline_3way.home * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.moneyline_3way.home_odds >= 0 ? '+' : ''}${markets.moneyline_3way.home_odds}</div>
                            </div>
                            <div class="market-option" onclick="selectMarket('moneyline_3way', 'draw', 0, 'Draw', '${period}')">
                                <div class="team">Draw</div>
                                <div class="prob">${(markets.moneyline_3way.draw * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.moneyline_3way.draw_odds >= 0 ? '+' : ''}${markets.moneyline_3way.draw_odds}</div>
                            </div>
                            <div class="market-option" onclick="selectMarket('moneyline_3way', 'away', 0, '${gameInfo.away_team} (3-way)', '${period}')">
                                <div class="team">${gameInfo.away_team}</div>
                                <div class="prob">${(markets.moneyline_3way.away * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.moneyline_3way.away_odds >= 0 ? '+' : ''}${markets.moneyline_3way.away_odds}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Spread Markets
            if (markets.spread && Object.keys(markets.spread).length > 0) {
                html += `
                    <div class="market-section">
                        <div class="market-title">
                            Spread
                            <span class="market-subtitle">(Est: ${markets.estimated_spread.toFixed(1)})</span>
                        </div>
                `;
                
                const spreadLines = Object.keys(markets.spread).map(parseFloat).sort((a, b) => a - b);
                console.log('Rendering spread lines:', spreadLines);
                
                spreadLines.forEach(line => {
                    const spread = markets.spread[line];
                    if (!spread) {
                        console.error('Missing spread data for line:', line);
                        return;
                    }
                    
                    // Convert line to signed value based on who is favored
                    const signedLine = gameInfo.spread < 0 ? -line : line;
                    const homeDisplay = signedLine === 0 ? '0.0' : (signedLine > 0 ? `+${signedLine.toFixed(1)}` : signedLine.toFixed(1));
                    const awayDisplay = signedLine === 0 ? '0.0' : (signedLine > 0 ? signedLine.toFixed(1) : `+${(-signedLine).toFixed(1)}`);
                    
                    html += `
                        <div class="market-line">
                            <div class="line-label">${homeDisplay}</div>
                            <div class="market-option" onclick="selectMarket('spread', 'home', ${line}, '${gameInfo.home_team} ${homeDisplay}', '${period}')">
                                <div class="team">${gameInfo.home_team}</div>
                                <div class="prob">${(spread.home_cover * 100).toFixed(1)}%</div>
                                <div class="odds">${spread.home_odds >= 0 ? '+' : ''}${spread.home_odds}</div>
                            </div>
                            <div class="market-option" onclick="selectMarket('spread', 'away', ${line}, '${gameInfo.away_team} ${awayDisplay}', '${period}')">
                                <div class="team">${gameInfo.away_team}</div>
                                <div class="prob">${(spread.away_cover * 100).toFixed(1)}%</div>
                                <div class="odds">${spread.away_odds >= 0 ? '+' : ''}${spread.away_odds}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Total Markets
            if (markets.total && Object.keys(markets.total).length > 0) {
                html += `
                    <div class="market-section">
                        <div class="market-title">
                            Total
                            <span class="market-subtitle">(Est: ${markets.estimated_total.toFixed(1)})</span>
                        </div>
                `;
                
                const totalLines = Object.keys(markets.total).map(parseFloat).sort((a, b) => a - b);
                console.log('Rendering total lines:', totalLines);
                
                totalLines.forEach(line => {
                    const total = markets.total[line];
                    if (!total || !total.over || !total.under) {
                        console.error('Missing total data for line:', line, 'Data:', total);
                        return;
                    }
                    
                    html += `
                        <div class="market-line">
                            <div class="line-label">${line.toFixed(1)}</div>
                            <div class="market-option" onclick="selectMarket('total', 'over', ${line}, 'Over ${line.toFixed(1)}', '${period}')">
                                <div class="team">Over</div>
                                <div class="prob">${(total.over * 100).toFixed(1)}%</div>
                                <div class="odds">${total.over_odds >= 0 ? '+' : ''}${total.over_odds}</div>
                            </div>
                            <div class="market-option" onclick="selectMarket('total', 'under', ${line}, 'Under ${line.toFixed(1)}', '${period}')">
                                <div class="team">Under</div>
                                <div class="prob">${(total.under * 100).toFixed(1)}%</div>
                                <div class="odds">${total.under_odds >= 0 ? '+' : ''}${total.under_odds}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Highest Scoring Quarter (Full Game only)
            if (period === 'full' && markets.highest_scoring_quarter) {
                html += `
                    <div class="market-section">
                        <div class="market-title">Highest Scoring Quarter</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.625rem; margin-bottom: 0.5rem;">
                            <div class="market-option" onclick="selectMarket('highest_scoring_quarter', 'q1', 0, '1st Quarter Highest', '${period}')">
                                <div class="team">1st Quarter</div>
                                <div class="prob">${(markets.highest_scoring_quarter.q1.prob * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.highest_scoring_quarter.q1.odds >= 0 ? '+' : ''}${markets.highest_scoring_quarter.q1.odds}</div>
                            </div>
                            <div class="market-option" onclick="selectMarket('highest_scoring_quarter', 'q2', 0, '2nd Quarter Highest', '${period}')">
                                <div class="team">2nd Quarter</div>
                                <div class="prob">${(markets.highest_scoring_quarter.q2.prob * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.highest_scoring_quarter.q2.odds >= 0 ? '+' : ''}${markets.highest_scoring_quarter.q2.odds}</div>
                            </div>
                            <div class="market-option" onclick="selectMarket('highest_scoring_quarter', 'q3', 0, '3rd Quarter Highest', '${period}')">
                                <div class="team">3rd Quarter</div>
                                <div class="prob">${(markets.highest_scoring_quarter.q3.prob * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.highest_scoring_quarter.q3.odds >= 0 ? '+' : ''}${markets.highest_scoring_quarter.q3.odds}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.625rem;">
                            <div class="market-option" onclick="selectMarket('highest_scoring_quarter', 'q4', 0, '4th Quarter Highest', '${period}')">
                                <div class="team">4th Quarter</div>
                                <div class="prob">${(markets.highest_scoring_quarter.q4.prob * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.highest_scoring_quarter.q4.odds >= 0 ? '+' : ''}${markets.highest_scoring_quarter.q4.odds}</div>
                            </div>
                            <div class="market-option" onclick="selectMarket('highest_scoring_quarter', 'tie', 0, 'Tie (Multiple Quarters)', '${period}')">
                                <div class="team">Tie</div>
                                <div class="prob">${(markets.highest_scoring_quarter.tie.prob * 100).toFixed(1)}%</div>
                                <div class="odds">${markets.highest_scoring_quarter.tie.odds >= 0 ? '+' : ''}${markets.highest_scoring_quarter.tie.odds}</div>
                            </div>
                            <div style="visibility: hidden;"></div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            console.log('=== END DISPLAY DEBUG ===');
            document.getElementById('markets-content').innerHTML = html;
        }

        function selectMarket(type, side, line, displayText, period) {
            const periodNames = {
                'q1': 'Q1', 'q2': 'Q2', 'q3': 'Q3', 'q4': 'Q4',
                'h1': '1H', 'h2': '2H', 'full': 'FG'
            };
            
            const selection = {
                type: type,
                side: side,
                team: side,
                line: line,
                display: displayText,
                period: period,
                periodDisplay: periodNames[period]
            };
            
            // Check if already selected
            const existingIndex = parlaySelections.findIndex(s =>
                s.type === type && s.side === side && s.line === line && s.period === period
            );
            
            if (existingIndex >= 0) {
                parlaySelections.splice(existingIndex, 1);
            } else {
                parlaySelections.push(selection);
            }
            
            updateParlayDisplay();
            calculateParlay();
        }

        function updateParlayDisplay() {
            const container = document.getElementById('sgp-selections');
            
            if (parlaySelections.length === 0) {
                container.innerHTML = '<div style="color: #6b7280; text-align: center;">Select markets to build parlay</div>';
                document.getElementById('sgp-result').style.display = 'none';
                return;
            }
            
            container.innerHTML = parlaySelections.map((sel, i) => `
                <div class="sgp-selection">
                    <div>
                        <span class="sgp-period-badge">${sel.periodDisplay}</span>
                        <span class="sgp-selection-text">${sel.display}</span>
                    </div>
                    <button class="remove-btn" onclick="removeParlaySelection(${i})">Remove</button>
                </div>
            `).join('');
        }

        function removeParlaySelection(index) {
            parlaySelections.splice(index, 1);
            updateParlayDisplay();
            calculateParlay();
        }

        async function calculateParlay() {
            if (parlaySelections.length === 0 || !currentData) {
                document.getElementById('sgp-result').style.display = 'none';
                return;
            }
            
            try {
                const selections = parlaySelections.map(sel => ({
                    type: sel.type,
                    side: sel.side,
                    team: sel.team,
                    line: sel.line,
                    period: sel.period
                }));
                
                const response = await fetch('/api/calculate-parlay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spread: currentData.game_info.spread,
                        total: currentData.game_info.total,
                        selections: selections
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    document.getElementById('sgp-prob').textContent = `${(result.probability * 100).toFixed(1)}%`;
                    document.getElementById('sgp-odds').textContent = result.fair_odds >= 0 ? `+${result.fair_odds}` : result.fair_odds;
                    document.getElementById('sgp-decimal').textContent = result.decimal_odds.toFixed(2);
                    
                    document.getElementById('sgp-result').style.display = 'block';
                }
            } catch (error) {
                console.error('Parlay calculation error:', error);
            }
        }

        window.addEventListener('load', function() {
            updateStatus();
            loadGames();
        });
    </script>
</body>
</html>